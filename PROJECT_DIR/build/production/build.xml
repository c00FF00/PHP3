<?xml version="1.0" encoding="UTF-8"?>

<project name="test.com" default="build" basedir=".">

    <target name="build" depends="copy, configs, composer, postdeploy, symlink"/>

    <tstamp>
        <format property="TimeStamp" pattern="%Y-%m-%d-%H-%M-%S" locale="ru"/>
    </tstamp>

    <target name="vars">
        <property name="domain" value="test.com"/>
        <property name="configname" value="config.json"/>
        <property name="root.dir" value="/var/www/html/PHP3/htdocs"/>
        <resolvepath propertyName="target.dir" file="${root.dir}/${TimeStamp}"/>
    </target>

    <target name="copy" depends="vars">
        <copy todir="${target.dir}">
            <fileset dir="${project.basedir}">
                <include name="**"/>
                <exclude name="vendor/**"/>
            </fileset>
        </copy>
    </target>

    <target name="configs" depends="vars">
        <copy todir="${target.dir}/config" file="${project.basedir}/config/app.php" overwrite="true">
            <filterchain>
                <replacetokens begintoken="{{" endtoken="}}">
                    <token key="domain" value="${domain}"/>
                </replacetokens>
            </filterchain>
        </copy>
        <copy todir="${target.dir}/config" file="${project.basedir}/config/database.php" overwrite="true">
            <filterchain>
                <replacetokens begintoken="{{" endtoken="}}">
                    <token key="mysqldbpassw" value="${mysqldbpassw}"/>
                </replacetokens>
            </filterchain>
        </copy>
    </target>

    <target name="composer" depends="vars">
        <exec command="composer install" dir="${target.dir}" checkreturn="true" passthru="true"/>
    </target>

    <target name="postdeploy">
        <exec command="php artisan migrate:refresh --seed" dir="${target.dir}" checkreturn="true" passthru="true"/>
    </target>

    <target name="symlink" depends="vars">
        <symlink target="${target.dir}" link="${root.dir}/current" overwrite="true"/>
    </target>

</project>

